<ion-header>
  <ion-toolbar class="toolbar-grey">
    <ion-title>{{ selectedStatusType?.text || 'Holdings' }}</ion-title>
  </ion-toolbar>

  <ion-toolbar class="summary-toolbar toolbar-grey">
    <div class="summary-left">
      <div class="summary-row">
        <span class="label">Invested</span>
        <span class="value">{{ investment | roundOff }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Current</span>
        <span class="value">{{ investment + pnl_val | roundOff }}</span>
      </div>
      <div class="summary-row">
        <span class="label">P&L</span>
        <span class="value" [ngStyle]="{ color: pnl_val > 0 ? '#28ba62' : '#eb445a' }">
          {{ pnl_val | roundOff }} ({{ getPnlPer() }})
        </span>
      </div>
    </div>
  </ion-toolbar>

  <ion-toolbar class="icon-toolbar toolbar-grey">
    <ion-buttons slot="end" style="position: relative;">
      
      <!-- Hidden Select -->
      <ion-select #sortSelect interface="popover" 
                  (ionChange)="setSort($event.detail.value.field, $event.detail.value.order)" 
                  placeholder="" okText="Select" cancelText="Cancel" 
                  style="opacity:0; position:absolute; right:0; top:0; bottom:0; width:40px;">
        <ion-select-option [value]="{field:'name', order:'asc'}">Name A-Z</ion-select-option>
        <ion-select-option [value]="{field:'name', order:'desc'}">Name Z-A</ion-select-option>
        <ion-select-option [value]="{field:'pnl', order:'asc'}">P&L Low-High</ion-select-option>
        <ion-select-option [value]="{field:'pnl', order:'desc'}">P&L High-Low</ion-select-option>
        <ion-select-option [value]="{field:'investment', order:'asc'}">Invest Low-High</ion-select-option>
        <ion-select-option [value]="{field:'investment', order:'desc'}">Invest High-Low</ion-select-option>
      </ion-select>

      <!-- Visible Icon -->
      <ion-icon name="swap-vertical-outline" style="font-size:24px; cursor:pointer;" 
                (click)="openSortPopover(sortSelect)">
      </ion-icon>
      
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen class="content-adjust">
  <ion-card *ngFor="let holding of sortedHoldings; trackBy: trackByHoldingId; let i = index" class="holding-card">
    <div class="details">
      <div class="container">
        <div class="left">
          <p class="holding-name">{{ holding.name }}</p>
          <div class="field-row"><span class="title">Qty</span><span class="value">{{ holding.totalQty }}</span></div>
          <div class="field-row"><span class="title">Invested</span><span class="value">₹{{ holding.totalInvested | roundOff }}</span></div>
        </div>
        <div class="right">
          <div class="field-row">
            <span class="title">P&L</span>
            <span class="value" [ngClass]="getHoldingPnL(holding) >= 0 ? 'positive' : 'negative'">
              ₹{{ getHoldingPnL(holding) | roundOff }}
              <span *ngIf="holding.totalInvested > 0">
                ({{ ((getHoldingPnL(holding)/holding.totalInvested)*100) | roundOff }}%)
              </span>
            </span>
          </div>
          <div class="field-row"><span class="title">Avg</span><span class="value">₹{{ holding.avgPrice | roundOff }}</span></div>
          <div class="field-row"><span class="title">SL/Exit</span><span class="value">₹{{ holding.stoploss }}</span></div>
        </div>
      </div>
    </div>

    <ng-container *ngIf="expandedIndex === i">
      <ng-container *ngFor="let trade of sortedTradesMap.get(holding.id) || []; trackBy: trackByTradeId">
        <app-trade-item [trade]="trade" (click)="openTradeActions(trade, holding)"></app-trade-item>
      </ng-container>
    </ng-container>

    <div class="breakdown_label" (click)="toggleExpand(i)">
      <ion-icon [name]="expandedIndex === i ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
      {{ expandedIndex === i ? 'Hide' : 'Show' }} Breakdowns
    </div>
  </ion-card>

  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="openAddHoldingModal()"><ion-icon name="add"></ion-icon></ion-fab-button>
  </ion-fab>
</ion-content>
